@inherits UmbracoViewPage
@{
    Layout = "CheckoutLayout.cshtml";

    var store = Model.GetStore();

    var currentOrder = UmbracoCommerceApi.Instance.GetCurrentOrder(store.Id);

    var shippingCountryId = currentOrder.ShippingInfo.CountryId.HasValue
        ? currentOrder.ShippingInfo.CountryId
        : currentOrder.PaymentInfo.CountryId;

    var shippingRegionId = currentOrder.ShippingInfo.CountryId.HasValue
        ? currentOrder.ShippingInfo.RegionId
        : currentOrder.PaymentInfo.RegionId;

    var shippingCountry = shippingCountryId.HasValue
        ? UmbracoCommerceApi.Instance.GetCountry(shippingCountryId.Value)
        : null;

    var shippingRegion = shippingRegionId.HasValue
        ? UmbracoCommerceApi.Instance.GetCountry(shippingRegionId.Value)
        : null;

    IEnumerable<ShippingMethodReadOnly> shippingMethods = UmbracoCommerceApi.Instance.GetShippingMethodsAllowedIn(shippingCountryId.Value, shippingRegionId);

    var currentShippingMethodId = currentOrder.ShippingInfo.ShippingMethodId.HasValue
        ? currentOrder.ShippingInfo.ShippingMethodId.Value
        : shippingRegion != null && shippingRegion.DefaultShippingMethodId.HasValue && shippingMethods.Any(x => x.Id == shippingRegion.DefaultShippingMethodId.Value)
            ? shippingRegion.DefaultShippingMethodId.Value
            : shippingCountry != null && shippingCountry.DefaultShippingMethodId.HasValue && shippingMethods.Any(x => x.Id == shippingCountry.DefaultShippingMethodId.Value)
                ? shippingCountry.DefaultShippingMethodId.Value
                : shippingMethods.FirstOrDefault()?.Id;

    var checkoutPage = Model.GetCheckoutPage();
    var nextStepPage = Model.GetNextPage();
}

@using (Html.BeginUmbracoForm("UpdateOrderShippingMethod", "CheckoutSurface"))
{
    <input type="hidden" name="nextStep" value="@(nextStepPage?.Key)" />

    <h3 class="text-xl text-white font-medium mb-4">Shipping Method</h3>
    <ul class="border border-gray-800 rounded">
        @foreach (var item in shippingMethods.Select((sm, i) => new { ShippingMethod = sm, Index = i }))
        {
            <li class="border-gray-800 @(item.Index > 0 ? "border-t " : "")">
                <label class="flex items-center py-4 px-4 cursor-pointer hover:bg-gray-900">
                    <input name="shippingMethod" type="radio" value="@item.ShippingMethod.Id" class="mr-3" @Html.Raw(currentShippingMethodId.HasValue && currentShippingMethodId.Value == item.ShippingMethod.Id ? "checked=\"checked\"" : "") required />
                    <span class="text-white font-medium">@(item.ShippingMethod.Name)</span>
                    <span class="text-white flex-1 text-right">@(item.ShippingMethod.CalculatePrice()?.Formatted())</span>
                </label>
            </li>
        }
    </ul>

    @await Html.PartialAsync("~/Views/Partials/CheckoutPrevNext.cshtml")
}
